
# Tiger ERP 产品需求文档 (PRD) & 现状评估

**版本**: 1.1
**日期**: 2026-01-19
**状态**: 核心功能开发中 / 部分模块已上线

## 1. 产品概述 (Overview)

**Tiger ERP** 是一款专为亚马逊（Amazon）跨境电商卖家设计的垂直 SaaS 系统。它不同于传统的纯云端 ERP，采用了**“本地数据库优先 (Local-First) + 智能增量同步”**的架构，旨在解决跨境网络延迟导致的数据加载慢、操作卡顿等痛点。

### 核心设计理念
1.  **极速响应**：前端操作（搜索、筛选、翻页）优先读取本地 MySQL，实现毫秒级响应。
2.  **所见即最新**：采用“视口优先更新”策略，用户当前看到的订单会优先触发远程同步。
3.  **业财一体**：深度整合订单流与资金流（集成菜狗支付），直接在 CRM 中闭环交易。

---

## 2. 功能模块需求与完成度矩阵

图例：
- ✅ **[已完成/真实]**：逻辑已通，对接了真实数据库或 API。
- ⚠️ **[部分完成]**：UI 已就绪，部分逻辑真实，部分仍需完善。
- 🚧 **[Mock/开发中]**：UI 已就绪，但数据源为静态 Mock 数据。

### 2.1 订单管理 (Order Management)
此模块是系统的核心，完成度极高。

| 功能点 | 详细需求描述 | 当前状态 | 备注 |
| :--- | :--- | :--- | :--- |
| **全平台订单列表** | 展示多站点、多店铺订单；支持自定义列配置、冻结列、列宽拖拽。 | ✅ **[真实]** | 后端 `/api/orders/db/list` 提供支持，前端实现了虚拟滚动和复杂表格。 |
| **数据同步机制** | **自动同步**：后台定时抓取最近 24h 数据。<br>**手动同步**：点击刷新或特定日期范围。<br>**热更新**：可视区域内的订单 ID 优先同步状态。 | ✅ **[真实]** | 核心竞争力功能。实现了智能水位线、防死循环、API 节流 (1.1s)。 |
| **高级筛选** | 支持按订购/付款/退款时间、店铺、站点、状态、配送方式 (FBA/FBM) 筛选；支持批量订单号搜索。 | ✅ **[真实]** | 前端筛选状态持久化到 LocalStorage，后端 SQL 动态拼接支持。 |
| **多商品展示** | 单个订单包含多个 SKU 时，需在列表中垂直堆叠展示，并正确显示促销 ID。 | ✅ **[真实]** | 数据库结构已升级为复合主键，支持拆单和多 Item 存储。 |
| **历史数据补全** | 支持手动触发“历史爬虫”，补全过去 1-2 年的数据。 | ✅ **[真实]** | `scripts/audit.js` 和后端接口均已实现分块抓取。 |
| **备注管理** | 支持添加本地备注，不覆盖亚马逊原始备注。 | ✅ **[真实]** | 数据库字段 `local_note` 已实装。 |

### 2.2 实时销量看板 (Real-Time Analysis)
此模块用于高频监控销量趋势，逻辑复杂。

| 功能点 | 详细需求描述 | 当前状态 | 备注 |
| :--- | :--- | :--- | :--- |
| **多维度聚合** | 支持按 **ASIN**、**MSKU**、**父ASIN** 维度聚合统计销量。 | ✅ **[真实]** | 后端 `controllers/realtime.js` 实现了复杂的 SQL `GROUP BY` 逻辑。 |
| **多时段对比** | 展示今日（实时）、昨日、上周同日、去年同日的销量/订单量/销售额对比。 | ✅ **[真实]** | 后端根据各站点时区（如 US=-8, JP=9）动态计算“当地今日”时间窗口。 |
| **自定义列配置** | 极其复杂的列配置，支持分组（基础信息、FBA库存等）、排序、显隐。 | ✅ **[真实]** | 前端实现了复杂的模态框配置和表头渲染逻辑。 |
| **库存集成** | 展示 FBA 可售、预留、在途以及 AWD 库存。 | ⚠️ **[部分]** | UI 列已存在，但后端 SQL 中库存字段目前可能尚未完全对接实时库存 API（当前主要聚合订单表数据）。 |

### 2.3 营销与 CRM (Facebook & Payment)
集成了社交媒体与支付，完成度较高。

| 功能点 | 详细需求描述 | 当前状态 | 备注 |
| :--- | :--- | :--- | :--- |
| **FB 消息互动** | 集成 Facebook Graph API，管理多个主页私信，支持发图/发文。 | ✅ **[真实]** | 支持多账号切换，消息实时拉取。 |
| **智能订单核对** | 自动识别聊天内容中的 Amazon 订单号格式，查询本地库并标记状态。 | ✅ **[真实]** | 正则匹配 + 本地库查询逻辑已实现。 |
| **菜狗支付集成** | 在聊天窗口直接发起 PayPal 返款/支付，自动计算手续费。 | ✅ **[真实]** | 已对接菜狗支付 API (Token 获取、创建订单、余额查询)。 |
| **凭证生成** | 支付成功后，前端动态生成包含交易号的图片凭证 (Canvas)。 | ✅ **[真实]** | 前端 Canvas 绘图逻辑完整。 |
| **虚拟客户模式** | 用于演示或测试的模拟对话功能。 | ✅ **[真实]** | 数据库 `virtual_customers` 表支持。 |

### 2.4 商品管理 (Product Management)
目前主要处于 UI 展示阶段。

| 功能点 | 详细需求描述 | 当前状态 | 备注 |
| :--- | :--- | :--- | :--- |
| **商品列表** | 展示本地商品库，包含图片、成本、头程、状态等。 | 🚧 **[Mock]** | `pages/Product/ProductList` 使用 `MOCK_PRODUCTS` 数组。 |
| **多属性管理** | 管理变体关系。 | 🚧 **[Mock]** | 页面结构已出，无真实数据。 |

### 2.5 仪表盘 (Dashboard)
首页概览。

| 功能点 | 详细需求描述 | 当前状态 | 备注 |
| :--- | :--- | :--- | :--- |
| **核心 KPI** | 展示销量、销售额、广告费、毛利等核心指标卡片。 | 🚧 **[Mock]** | `/api/dashboard/overview` 返回的是写死的 JSON 数据。 |
| **排行榜** | Top 50 商品排行。 | 🚧 **[Mock]** | 数据随机生成。 |
| **待办事项** | 采购、发货待办计数。 | 🚧 **[Mock]** | 静态数据。 |

### 2.6 设置与基础 (Settings)
| 功能点 | 详细需求描述 | 当前状态 | 备注 |
| :--- | :--- | :--- | :--- |
| **店铺授权** | 管理 Amazon 店铺授权状态，查看 SellerID。 | ✅ **[真实]** | 对接了赛狐的店铺列表 API。 |
| **FB 账号设置** | 输入 Token 自动智能解析主页并绑定。 | ✅ **[真实]** | 支持 User Token 解析 Page Token 的逻辑。 |

---

## 3. 非功能性需求与架构现状

### 3.1 数据同步策略 (已实现)
*   **智能水位线 (Smart Watermark)**：不仅仅记录一个“上次同步时间”。系统会根据店铺的活跃度（最近3天是否有单），计算出所有活跃店铺中最旧的订单时间，作为同步起点。这有效解决了跨时区（如美国vs日本）导致的数据漏抓问题。
*   **防死循环**：爬虫包含死循环熔断机制，如果页码翻页但订单ID未变，自动停止。
*   **启动自愈**：服务器启动时，会自动在该台异步触发一次数据修补任务。

### 3.2 安全性 (Security)
*   **零硬编码**：所有敏感信息（DB密码、API Secret、FB Token）已从代码中移除，强制通过环境变量 (`.env`) 读取。
*   **API 代理**：前端不直接请求外部 API（Sellfox/CaiGou），全部通过 Node.js 中间层代理，隐藏了签名算法和密钥。

### 3.3 数据库设计
目前 MySQL 数据库 Schema 设计已趋于稳定，支持复杂业务：
*   `orders`：主订单表，复合主键 (Order ID + Store Name) 支持拆单。
*   `order_items`：商品明细，包含 SKU、ASIN、价格、促销ID。
*   `user_settings`：存储前端的用户偏好（如自定义列配置）。
*   `fb_accounts` & `virtual_messages`：存储 CRM 数据。

---

## 4. 下一步开发建议 (Gap Analysis)

根据现状分析，以下是建议的后续开发重点：

1.  **Dashboard 真实化**：首页仪表盘目前全是 Mock 数据。建议编写后端聚合接口，复用 `orders` 表的数据来生成真实的 KPI 和图表。
2.  **库存模块对接**：RealTime 页面中的库存字段（FBA可售、在途）目前是空的。需要对接赛狐的库存 API，并同步到本地数据库。
3.  **商品成本录入**：为了计算真实的利润（Profit），需要在商品管理模块实现“采购成本”和“头程运费”的录入与存储功能，并关联到 `order_items` 表的利润计算逻辑中。
4.  **广告数据集成**：目前的 RealTime 页面预留了广告花费、广告销售额字段，但数据库中尚未包含广告报表数据。
